<!DOCTYPE html>
<html>
    <head>
        {{ cookie_banner|safe }}
        <title>sc-explorer</title>
        <script src="https://w.soundcloud.com/player/api.js" type="text/javascript"></script>
        <script
			  src="https://code.jquery.com/jquery-3.7.0.min.js"
			  integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g="
			  crossorigin="anonymous">
        </script>
        <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    </head>
     
    <body>
        <center>
        <a href=""><h1>sc-explorer</h1></a>
        <a href="/cookie-declaration">Cookie declaration</a>
        <h3>Play the most commented 10 seconds of a random song on SoundCloudÂ® and add it to a playlist if you like it!</h3>
        <h4>When you are satisfied, click on "Create playlist" to stop exploring and generate your playlist!</h4> 
        <br>
        <table width="100%">
        <tr>
            <td width="30%" style="text-align:right"><button style="display:none;height:166px;width:200px" id="skip">Skip</button></td>
            <td width="40%"><iframe id="sc-widget" style="display: none" width="100%" height="166px" scrolling="no" frameborder="no" src="https://w.soundcloud.com/player/?url=https://soundcloud.com/vocaltrance4ever/sets/april-2023-new-dance-songs?auto_play=false"></iframe>
            </td>
            <td width="30%" style="text-align:left"><button style="display:none;height:166px;width:200px" id="add">Add to playlist</button></td>
        </tr>
        <tr>
            <td colspan="3" style="text-align:center"><button style="display:none;height:70px;width:35%" disabled onclick="createPlaylist()" id="create">Create playlist</button></td>
        </tr>
        </table>
        <p id="playlist_url_label">Insert playlist url:</p>&nbsp;&nbsp;<input type="text" id="playlist_url" />
        <br><br>
        <button id="beginExploring" style="display:block;height:166px;width:200px" onclick="beginExploring()">Begin exploring</button> 
        </center>
        <center>
        <form method="POST" id="form" action="/add_songs_to_playlist">
            <div id="captcha" class="g-recaptcha" data-sitekey="{{website_key}}" data-callback="enableCreate" hidden></div>
            <input id="liked_songs" type="hidden" name="songs" value="">
        </form>
        </center>
        <script type="text/javascript">
            var creatingPlaylist = false;
            var widgetIframe = document.getElementById('sc-widget');
            var widget = SC.Widget(widgetIframe);
            var liked_songs = [];

            function enableCreate() {
                document.getElementById('liked_songs').value = JSON.stringify(liked_songs);
                document.getElementById('form').submit();
            }

            function createPlaylist() {
                widget.pause();
                creatingPlaylist = true;
                document.getElementById('captcha').style.display = 'inline-block';
                document.getElementById('create').disabled = true;
                document.getElementById('create').innerHTML = 'Please, complete the captcha to complete';
            }

            function getPromiseFromEvent(items, event, song_id) {
                return new Promise((resolve) => {
                    const listener = (evt) => {
                        if (evt.srcElement.id == 'add') {
                            liked_songs.push(song_id);
                            document.getElementById('create').disabled = false;
                        }
                        items.forEach(function (currentValue, currentIndex, listObj) {
                            currentValue.removeEventListener(event, listener);
                        });
                        resolve();
                    }

                    items.forEach(function (currentValue, currentIndex, listObj) {
                        currentValue.addEventListener(event, listener);
                    });
                })
            }

            function beginExploring() {
                playlist_url = document.getElementById('playlist_url').value;
                widget.load(playlist_url);
                document.getElementById('playlist_url').style.display = 'none';
                document.getElementById('playlist_url_label').style.display = 'none';
                document.getElementById('beginExploring').style.display = 'none';
                document.getElementById('skip').style.display = 'inline-block';
                document.getElementById('add').style.display = 'inline-block';
                document.getElementById('create').style.display = 'inline-block';
                widgetIframe.style.display = 'block';
                
                const buttons = [document.getElementById('skip'), document.getElementById('add')];

                widget.bind(SC.Widget.Events.READY, function() {
                    widget.getSounds(async function(sound_array) {
                        for (let i = 0; i < sound_array.length; i++) {
                            buttons.forEach((b) => b.disabled = true);
                            let r = $.ajax({
                                type: 'POST',
                                url: '/most_commented_window_position',
                                data: {song_id: sound_array[i].id},
                                async: false,
                                success: () => {}
                            });

                            if (r.status != 200 || r.responseJSON.position == -1) {
                                continue;
                            }
                            
                            let window_position = r.responseJSON.position;
                            if (window_position == -1) {
                                alert('There was an error locating the most commented 10 seconds... Defaulting to 0');
                                window_position = 0;
                            }
                            widget.skip(i);
                            widget.seekTo(window_position);
                            widget.play();
                            await new Promise(r => setTimeout(r, 11000));
                            widget.pause();
                            if (!creatingPlaylist)
                                buttons.forEach((b) => b.disabled = false);
                            await getPromiseFromEvent(buttons, "click", sound_array[i].id)
                        }
                        alert('You listened to every song in this playlist! Create your playlist or start over again');
                    });
                });
            }
        </script>
        <script>
           function onSubmit(token) {
             document.getElementById("demo-form").submit();
           }
         </script>

    </body>
</html>
